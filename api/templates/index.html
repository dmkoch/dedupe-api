{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        {% if 'admin' in roles %}
            <h2 class='pull-right' id='start-session-btn' style='display: none;'><a role="button" href="{{url_for('trainer.train')}}" class="btn btn-info"><i class='fa fa-plus-circle'></i> Start a new dedupe session</a></h2>

            <div id='start-session' style='display: none;'>
                <h3>Hi there {{user.name|title}} Welcome to dedupe!</h3>
                <p>Let's get started on your first dedupe session.</p>
                <a role="button" href="{{url_for('trainer.train')}}" class="btn btn-info btn-lg"><i class='fa fa-plus-circle'></i> Start a new dedupe session</a>
            </div>
        {% endif %}
        <div id='dedupe-sessions' style='display: none;'>
            <div class="row">
                <div class="col-md-9">
                    <h2>Dedupe sessions</h2>
                </div>
                <div class="col-md-3">
                    <a role="button" href="{{url_for('trainer.train')}}" class="btn btn-info">
                        <i class='fa fa-plus-circle'></i>
                        Start a new dedupe session
                    </a>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr id="review-header">
                                <th>Name</th>
                                <th>Actions</th>
                                <th>Entity count</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="session-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_javascript %}
<script type='text/javascript'>
    function make_display(resp){
        var rows = ''
        if (resp.objects.length > 0) {
            $.each(resp.objects, function(i, object){
                rows += '<tr><td><a href="/session-admin/' + object.id + '/">' + object.name + '</td>';
                rows += '<td>';
                if (object.status == 'entity map updated'){
                    rows += '<a href="/session-review/' + object.id + '/">Review Queue</a><br />';
                } else if (object.status == 'session initialized'){
                    rows += '<a href="/select-fields/?session_id=' + object.id + '">Define Model</a><br />';
                } else if (object.status == 'canon clustered'){
                    rows += '<a href="/session-review/' + object.id + '/?second_review=true">Second Review</a><br />';
                } else if (object.status == 'matching ready'){
                    rows += '<a href="/match-review/' + object.id + '/?second_review=true">Final Review</a><br />';
                }
                if (object.status && object.status != 'session initialized'){
                    rows += '<a href="/training-run/?session_id=' + object.id + '">Add training</a><br />';
                }
                rows += '<a class="delete-model" href="javascript://" data-session_id="' + object.id + '">Delete Data Model</a><br/>';
                rows += '</td>';
                rows += '<td>' + object.entity_count + '</td>';
                rows += '<td><a class="delete-session" href="javascript://" data-session_id="' + object.id + '">Delete</a></td>';
                rows += '</tr>';
            });
            $('#dedupe-sessions').show();
            $('#session-list').html(rows);
        }
        else {
            $('#start-session').show();
            $('#start-session-btn').hide();
        }
        $('.delete-session').on('click', function(e){
            e.preventDefault();
            var sess_id = $(this).data('session_id');
            console.log(sess_id);
            var row = $(this).parent().parent()
            $.when($.getJSON('/delete-session/' + sess_id + '/')).then(
                function(data){
                    $(row).remove();
                }
            )
        })
        $('.delete-model').on('click', function(e){
            e.preventDefault();
            var sess_id = $(this).data('session_id');
            console.log(sess_id);
            var row = $(this).parent()
            $.when($.getJSON('/delete-data-model/' + sess_id + '/')).then(
                function(data){
                    $.when($.getJSON('/session-list/')).then(
                      function(resp){
                          make_display(resp)
                      }
                    )
                }
            )
        })

    }
    $(document).ready(function(){
        $.when($.getJSON('/session-list/')).then(
          function(resp){
              make_display(resp)
          }
        )
    })
</script>
{% endblock %}
