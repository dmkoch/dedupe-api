{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-12">
        {% if 'admin' in roles %}
            <h2 class='pull-right'><a role="button" href="{{url_for('trainer.train')}}" class="btn btn-info"><i class='fa fa-plus-circle'></i> Start a new dedupe session</a></h2>
        {% endif %}
        <h2>Dedupe sessions</h2>
        <table class="table table-bordered table-striped">
            <thead>
                <tr id="review-header">
                    <th>Name</th>
                    <th>Actions</th>
                    <th>Entity count</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="session-list"></tbody>
        </table>
    </div>
</div>
{% endblock %}
{% block extra_javascript %}
<script type='text/javascript'>
    function make_display(resp){
        var rows = ''
        $.each(resp.objects, function(i, object){
            rows += '<tr><td>' + object.name + '</td>';
            rows += '<td>';
            if (object.status == 'entity map updated'){
                rows += '<a href="/session-review/' + object.id + '/">Review Queue</a><br />';
            } else if (object.status == 'session initialized'){
                rows += '<a href="/select-fields/?session_id=' + object.id + '">Define Model</a><br />';
            } else if (object.status == 'training started' || object.status == 'entity map initialized'){
                rows += '<a href="/training-run/?session_id=' + object.id + '">Start training</a><br />';
            }  else if (object.status == 'canon clustered'){
                rows += '<a href="/session-review/' + object.id + '/?second_review=true">Second Review</a><br />';
            }
            rows += '<a class="delete-model" href="javascript://" data-session_id="' + object.id + '">Delete Data Model</a><br/>';
            rows += '</td>';
            rows += '<td>' + object.entity_count + '</td>';
            rows += '<td><a class="delete-session" href="javascript://" data-session_id="' + object.id + '">Delete</a></td>';
            rows += '</tr>';
        });
        $('#session-list').html(rows);
        $('.delete-session').on('click', function(e){
            e.preventDefault();
            var sess_id = $(this).data('session_id');
            console.log(sess_id);
            var row = $(this).parent().parent()
            $.when($.getJSON('/delete-session/' + sess_id + '/')).then(
                function(data){
                    $(row).remove();
                }
            )
        })
        $('.delete-model').on('click', function(e){
            e.preventDefault();
            var sess_id = $(this).data('session_id');
            console.log(sess_id);
            var row = $(this).parent()
            $.when($.getJSON('/delete-data-model/' + sess_id + '/')).then(
                function(data){
                    $.when($.getJSON('/session-list/')).then(
                      function(resp){
                          make_display(resp)
                      }
                    )
                }
            )
        })

    }
    $(document).ready(function(){
        $.when($.getJSON('/session-list/')).then(
          function(resp){
              make_display(resp)
          }
        )
    })
</script>
{% endblock %}
