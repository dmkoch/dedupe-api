{% extends 'base.html' %}
{% block title %}Processing ... {% endblock %}
{% block content %}
    <div class="col-md-12">
        {% include "partials/dedupe_steps.html" %}
        <h3>Processing ...</h3>
        {% include "partials/error.html" %}
    </div>
    <div class="col-md-8">
        <div id='wait-info'>
            <div class='well'>
                <p>We are taking what we've learned from your training and
                applying it to the rest of your spreadsheet. <strong>This may take
                  a few minutes.</strong></p>

                <p>When finished, your deduplicated spreadsheet will be available to download below.</p>
            </div>
        </div>

        <div id='spinner'><br /><br /></div>
        <div id='results'>
        </div>
    </div>

{% endblock %}
{% block extra_javascript %}
<script src="{{ url_for('static', filename='js/spin.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.spin.js') }}"></script>
<script type="text/javascript">

    var recall_weight = "2";

    function display_links(data){
        $('#spinner').spin(false);
        $('#wait-info').slideUp();
        $('#results').html('<stong>Training session added!</strong> <a href="/">Continue to the review queue &raquo;</a>');

        // original, training, settings, deduped
        $('#recall_weight').val(recall_weight);

        $('#adjust_threshold').on('click', function(e){
            e.preventDefault();
            recall_weight= $('#recall_weight').val();
            $('#results').empty();
            $('#spinner').spin({'left': 0});
            $('#wait-info').slideDown();
            $.getJSON('/adjust_threshold/', {recall_weight: recall_weight}, function(resp){
                poll_worker();
            });
        })
    }

    function poll_worker(){
        $.ajax({
            url: '/working/',
            success: function(data){
                if (data.ready){
                    display_links(data);
                } else {
                    setTimeout(poll_worker, 3000);
                }
            },
            dataType: 'json',
        })
    }

    $('#spinner').spin({'left': 0});
    poll_worker();

</script>
{% endblock %}
