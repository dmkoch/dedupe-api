{% extends "base.html" %}
{% block title %} | Review Queue {% endblock %}
{% block content %}
    <div class="row">
      <div class="col-md-12">
          <div class="row">
              <div id="counter" class="col-md-9"></div>
              <div class="col-md-3">
                  <button class="btn btn-danger accept-all">
                      <i class='icon-ok'></i>
                      Accept the rest
                  </button>
              </div>
          </div>
          <div class="row">
              <div class="col-md-12">
                  <table class="table" id="group-display">
                      <thead></thead>
                      <tbody></tbody>
                  </table>
                  <div id="review-buttons">
                      <h4>Does the cluster above refer to the same entity? <span id="confidence"></span></h4>
                      <button class="btn btn-success mark-entity" id="yes">
                          <i class='icon-ok'></i>
                          Yes
                      </button>
                      <button class="btn btn-danger mark-entity" id="no">
                          <i class='icon-remove'></i>
                          No
                      </button>
                  </div>
              </div>
          </div>
      </div>
    </div>
{% endblock %}
{% block extra_javascript %}
<script src="{{ url_for('static', filename='js/spin.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery.spin.js') }}"></script>
<script type="text/javascript">
    $(document).ready(function(){
        get_cluster();
        $('.mark-entity').on('click', function(e){
            e.preventDefault();
            var entity_id = $('#group-display').data('group');
            var action = $(this).attr('id').split('_')[0];
            $.getJSON('/mark-cluster/{{session_id}}/', {'entity_id': entity_id, 'action': action}, function(resp){
                get_cluster();
            })
        })
        $('.accept-all').on('click', function(e){
            e.preventDefault();
            $.getJSON('/mark-all-clusters/{{session_id}}', {'action': 'yes'}, function(resp){
                $('#group-display').html("<h3>" + resp['message'] + "</h3>")
                $('#review-buttons').hide()
                $('#counter').parent().hide()
            })
        })
    });
    function get_cluster(){
        $('#group-display').spin('large');
        $.getJSON('/get-review-cluster/{{session_id}}/', {}, function(resp){
            $('#group-display').spin(false);
            if (resp.objects.length > 0){
                $('#counter').html('<p>' + resp.review_remainder + ' out of ' + resp.total_clusters + ' left to review</p>')
                var head = '';
                var body = '';
                $('#group-display').data('group', resp.entity_id);
                $.each(resp.objects, function(i, item){
                    if (i == 0){
                        head += '<tr>';
                        $.each(item, function(k,v){
                            head += '<th>' + k + '</th>';
                        });
                        head += '</tr>';
                    }
                    body += '<tr>';
                    $.each(item, function(k,v){
                        body += '<td>' + v + '</td>';
                    });
                    body += '</tr>';
                });
                $('#confidence').html('(confidence of ' + resp.confidence + ')');
                $('#group-display thead').html(head);
                $('#group-display tbody').html(body);
            } else {
                $('#group-display').html("<h3>You're done!</h3>")
                $('#review-buttons').hide()
                $('#counter').parent().hide()
            }
        })
    }
</script>
{% endblock %}
